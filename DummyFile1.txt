---
config:
  theme: 'dark'
  logLevel: 'error'
  sequence:
    mirrorActors: false
    showSequenceNumbers: true
---

sequenceDiagram
    actor Dev as <br/><br/>ABCD <br/>Deveoper    
    participant Repo as Azure Repos <br/>(Git)
    participant CI as CI Pipeline
    participant AzDOLib as Azure DevOps <br/>Library
    participant AStore as Artifacts <br/>Store
    participant CD as CD Pipeline
    participant AzDOEnv as Azure DevOps <br/>Environment
    actor PreDA as <br/><br/>Pre-Deploy <br/>Approver(s) 
    actor DL as <br/><br/>ABCD <br/>Dev Lead   
    actor STA as <br/><br/>Smoke Test <br/>Approver(s)
    participant Users as ABCD <br/>Users

    Dev->>Repo: Complete PR
    Dev->>CI: Trigger Pipeline  
    CI->>Repo: Fetch the source code
    par Build WCF Services
        CI->>CI: Build Services solution 
        CI->>AStore: Publish ABCD Services archive
    and Build Thick Client
        CI->>CI: Build Client solution 
        CI->>AzDOLib: Request Secrets for MSIX
        activate AzDOLib
        AzDOLib->>CI: Respond with requested Secrets
        deactivate AzDOLib
        CI->>AStore: Publish MSIX - ABCD Client
    and Build DB Projects
        CI->>CI: Build DB solution 
        CI->>AStore: Publish 3 dacpacs for each DB
    end
    CI->>CI: Code Scans (AZDO) & <br/>Unit Tests (To be included)
    alt Deploy "Disabled"
        rect rgb(140,0,0)  
            CI-->>CI: STOP <br/>pipeline execution    
        end    
    else Deploy "Enabled"
        CI->>CD: Trigger deploy stage     
    end
    CD->>AzDOEnv: Trigger Environment <br/>specific checks
    AzDOEnv->>CD: Respond with Checks result
    alt  Any checks "Failed"
        rect rgb(140,0,0) 
            CD->>CD: STOP <br/>pipeline execution  
        end    
    else All checks "Passed"
        CD->>PreDA: Request approval to deploy
        activate PreDA
        PreDA->>CD: Manual approval granted
        deactivate PreDA
        CD->>AStore: Pull down artifacts <br/>to deploy
        CD->>AStore: Create & Publish <br/>DB Diff scripts
        CD->>DL: Request Approval to Deploy
        activate DL
        DL->>AStore: Review DB Diff Scripts
        DL->>CD: Grant approval to execute
        deactivate DL
        CD->>CD: Deploy WCF Services
        CD->>STA: Notify deployment completion
        STA->>Users: Smoke test & <br/>Notify users     
    end
   
